---
layout: post
title: How to Create A Virtual Network System with Docker
link: virtual-network-systems
category: others
type: Others
---

The system will look like the following diagram:
<img src="/resource/img/ITSEC_virtual_network.png" width="600">
<br>
<strong>Note: the ip addresses of the VMs are different from the above diagram (also even if you don't use docker but normal VMs tool like VirtualBox...), but the method stays the same.</strong>
<ol>
    <li>Run the first router: <code>docker run --cap-add=NET_ADMIN -ti -p --name=router1 hungpham/ubuntu:v5 /bin/bash</code></li>
    <li>Run the second router: <code>docker run --cap-add=NET_ADMIN -ti -P --name=router2 hungpham/ubuntu:v5 /bin/bash</code></li>
    <li>Add interfaces to 2 routers:
        <br>
        <code>
            docker network connect br1 router1 <br>
            docker network connect br2 router2
        </code>
    </li>
    <li>Run 2 containers: <br>
        <code>
            docker run -ti --cap-add=NET_ADMIN --name=vm1 hungpham/ubuntu:v5 /bin/bash <br>
            docker run -ti --cap-add=NET_ADMIN --name=vm2 hungpham/ubuntu:v5 /bin/bash
        </code>
    </li>
    <li>Remove default interface in 2 VMs, and add new interface to them:<br>
        <code>
            docker network disconnect bridge vm1 <br>
            docker network disconnect bridge vm2<br>
            docker network connect br1 vm1<br>
            docker network connect br2 vm2<br>
        </code>
    </li>
    <li>Setup iptabble for both routers: <br>
        <code>
            iptables -t nat -A POSTROUTING --out-interface eth1 -j MASQUERADE <br>
            iptables -A FORWARD --in-interface eth0 -j ACCEPT<br>
            iptables -t nat -A POSTROUTING --out-interface eth0 -j MASQUERADE<br>
            iptables -A FORWARD --in-interface eth1 -j ACCEPT
        </code>
    </li>
    <li>For router1: <code>route add default gateway 172.17.0.3   (ip address of router 2)</code></li>
    <li>For router1: <code>route add default gateway 172.17.0.2   (ip address of router 1)</code></li>
    <li>For vm1: <code>route add default gateway 192.168.1.2</code></li>
    <li>For vm2: <code>route add default gateway 10.2.4.2</code></li>
</ol>